<!--
  File: defender_easm_discovery.xml
  Purpose: Manage â†’ Discovery
  Scope: Defender EASM discovery execution (tasks-based)
-->

<dashboard version="1.1">
  <label>Discovery</label>

  <description>
    Monitor Defender EASM discovery execution using task lifecycle data
    from the data-plane Tasks API.
  </description>

  <!-- ========================= -->
  <!-- BASE SEARCH -->
  <!-- ========================= -->
  <search id="base_discovery_tasks">
    <query>
      `easm_index`
      sourcetype=defender:easm:task
      | where task_type="Discovery"
      | eval startTime=strftime(startTime,"%Y-%m-%d %H:%M:%S")
      | eval endTime=strftime(endTime,"%Y-%m-%d %H:%M:%S")
    </query>
    <earliest>-30d@d</earliest>
    <latest>now</latest>
  </search>

  <!-- ========================= -->
  <!-- DISCOVERY OVERVIEW -->
  <!-- ========================= -->
  <row>
    <panel>
      <single>
        <title>Total Discovery Tasks</title>
        <search base="base_discovery_tasks">
          <query>| stats count</query>
        </search>
      </single>
    </panel>

    <panel>
      <single>
        <title>Running</title>
        <search base="base_discovery_tasks">
          <query>| search task_state="Running" | stats count</query>
        </search>
      </single>
    </panel>

    <panel>
      <single>
        <title>Succeeded</title>
        <search base="base_discovery_tasks">
          <query>| search task_state="Succeeded" | stats count</query>
        </search>
      </single>
    </panel>

    <panel>
      <single>
        <title>Failed</title>
        <search base="base_discovery_tasks">
          <query>| search task_state="Failed" | stats count</query>
        </search>
      </single>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- TASK STATE DISTRIBUTION -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Discovery Tasks by State</title>
      <chart>
        <search base="base_discovery_tasks">
          <query>
            | stats count by task_state
          </query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- EXECUTION TREND -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Discovery Execution Trend</title>
      <chart>
        <search base="base_discovery_tasks">
          <query>
            | timechart span=1d count by task_state
          </query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- DISCOVERY TASK DETAILS -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Discovery Task Details</title>
      <table>
        <search base="base_discovery_tasks">
          <query>
            | table
                task_id
                name
                task_state
                startTime
                endTime
                errorCode
                errorMessage
            | sort - startTime
          </query>
        </search>

        <option name="count">20</option>
        <option name="wrap">true</option>

        <drilldown>
          <link>
            <![CDATA[
              /app/microsoft_defender_easm/defender_easm_task_detail?task_id=$row.task_id$
            ]]>
          </link>
        </drilldown>
      </table>
    </panel>
  </row>

</dashboard>
