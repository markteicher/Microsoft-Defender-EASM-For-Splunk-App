<!-- defender_easm_privileged_activity.xml -->
<!-- Microsoft Defender EASM for Splunk App -->
<!-- Privileged Role Activity Spotlight -->

<dashboard version="1.1">
  <label>üîê Privileged Role Activity</label>

  <description>
    Spotlight on actions performed by privileged users (Owner, Contributor, Security Admin)
    related to Microsoft Defender External Attack Surface Management.
  </description>

  <!-- ========================= -->
  <!-- BASE SEARCH -->
  <!-- ========================= -->

  <search id="base_privileged_activity">
    <query>
      `easm_index`
      sourcetype=azure:activitylog
      | eval user=coalesce(caller, initiatedBy)
      | eval role=coalesce(roleName, assignedRole)
      | where role IN ("Owner","Contributor","Security Admin","Security Reader")
      | eval action=operationName
      | eval result=coalesce(status, resultType)
    </query>
    <earliest>-90d@d</earliest>
    <latest>now</latest>
  </search>

  <!-- ========================= -->
  <!-- KPI ROW -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>‚ö†Ô∏è Total Privileged Actions</title>
      <single>
        <search base="base_privileged_activity">
          <query>| stats count</query>
        </search>
      </single>
    </panel>

    <panel>
      <title>üë§ Privileged Users</title>
      <single>
        <search base="base_privileged_activity">
          <query>| stats dc(user)</query>
        </search>
      </single>
    </panel>

    <panel>
      <title>üõ°Ô∏è Privileged Roles</title>
      <single>
        <search base="base_privileged_activity">
          <query>| stats dc(role)</query>
        </search>
      </single>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- TOP PRIVILEGED USERS -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>üë• Top Privileged Users by Activity</title>
      <table>
        <search base="base_privileged_activity">
          <query>
            | stats count AS action_count BY user role
            | sort - action_count
            | head 10
          </query>
        </search>

        <drilldown>
          <link>
            <![CDATA[
              /app/microsoft_defender_easm/defender_easm_user_activity_detail?form.user=$row.user$
            ]]>
          </link>
        </drilldown>

        <option name="count">10</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- ROLE DISTRIBUTION -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>üß≠ Activity by Privileged Role</title>
      <chart>
        <search base="base_privileged_activity">
          <query>
            | stats count BY role
          </query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- ACTION TYPES -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>üìã Privileged Actions Performed</title>
      <table>
        <search base="base_privileged_activity">
          <query>
            | stats count BY action
            | sort - count
          </query>
        </search>
        <option name="count">15</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- TIME-BASED ACTIVITY -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>üìà Privileged Activity Over Time</title>
      <chart>
        <search base="base_privileged_activity">
          <query>
            | timechart span=1d count BY role
          </query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- RECENT PRIVILEGED ACTIONS -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>üö® Recent Privileged Actions</title>
      <table>
        <search base="base_privileged_activity">
          <query>
            | eval target=coalesce(resourceId, entityId)
            | table _time user role action target result
            | sort - _time
          </query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

</dashboard>
