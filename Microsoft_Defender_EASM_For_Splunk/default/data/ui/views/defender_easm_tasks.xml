<!-- default/data/ui/views/defender_easm_tasks.xml -->
<!-- Microsoft Defender EASM for Splunk App -->
<!-- Tasks Dashboard -->

<dashboard version="1.1" theme="light">
  <label>Tasks</label>

  <description>
    Execution status, duration, and outcomes for Microsoft Defender EASM tasks.
  </description>

  <!-- ========================= -->
  <!-- Task Summary -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Task Status Summary</title>
      <chart>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | stats count by status
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Task Execution Duration -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Task Execution Duration</title>
      <chart>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | eval
                start_epoch=strptime(startTime,"%Y-%m-%dT%H:%M:%S"),
                end_epoch=strptime(endTime,"%Y-%m-%dT%H:%M:%S")
            | where isnotnull(end_epoch)
            | eval duration_seconds=round(end_epoch-start_epoch,2)
            | timechart span=1h avg(duration_seconds) AS avg_duration_seconds
          </query>
        </search>
        <option name="charting.chart">line</option>
        <option name="legend.placement">none</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Task Table (Drilldown Enabled) -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Task Details</title>
      <table>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | eval
                start_epoch=strptime(startTime,"%Y-%m-%dT%H:%M:%S"),
                end_epoch=strptime(endTime,"%Y-%m-%dT%H:%M:%S")
            | eval
                duration_seconds=if(isnull(end_epoch),null(),round(end_epoch-start_epoch,2))
            | table
                taskId
                taskType
                status
                duration_seconds
                startTime
                endTime
                createdBy
            | sort -startTime
          </query>
        </search>

        <!-- DRILLDOWN -->
        <drilldown>
          <link>
            <![CDATA[
              /app/microsoft_defender_easm/defender_easm_task_detail?task_id=$row.taskId$
            ]]>
          </link>
        </drilldown>

        <option name="wrap">true</option>
        <option name="count">25</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Failed Tasks -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Failed Tasks</title>
      <table>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | where status="Failed" OR status="Error"
            | table
                taskId
                taskType
                failureReason
                errorCode
                startTime
                endTime
          </query>
        </search>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

</dashboard>
