<!-- defender_easm_user_activity.xml -->
<!-- Microsoft Defender EASM for Splunk App -->
<!-- User Activity & Audit Dashboard -->

<dashboard version="1.1">
  <label>User Activity & Audit</label>
  <description>
    Auditable user activity across Microsoft Defender External Attack Surface Management,
    including control-plane actions, discovery tasks, reports, and policy operations.
  </description>

  <!-- BASE SEARCH -->
  <search>
    <query>
      index=security_defender_easm
      (
        sourcetype=azure:activitylog
        OR sourcetype=defender:easm:task
        OR sourcetype=defender:easm:report
        OR sourcetype=defender:easm:policy
      )
      | eval user=coalesce(caller, initiatedBy, createdBy)
      | where isnotnull(user)
      | eval action=coalesce(operationName, taskType, reportType, policyName)
      | eval result=coalesce(status, resultType)
    </query>
    <earliest>-90d@d</earliest>
    <latest>now</latest>
  </search>

  <!-- KPI ROW -->
  <row>
    <panel>
      <title>Total User Actions</title>
      <single>
        <search>
          <query>
            | stats count
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>Unique Users</title>
      <single>
        <search>
          <query>
            | stats dc(user)
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>Actions (Last 24h)</title>
      <single>
        <search>
          <query>
            | where _time &gt; relative_time(now(), "-24h")
            | stats count
          </query>
        </search>
      </single>
    </panel>
  </row>

  <!-- TOP USERS -->
  <row>
    <panel>
      <title>Top 10 Users by Activity</title>
      <table>
        <search>
          <query>
            | stats count AS action_count by user
            | sort -action_count
            | head 10
          </query>
        </search>

        <drilldown>
          <link>
            <![CDATA[
              /app/microsoft_defender_easm/defender_easm_user_activity_detail?form.user=$row.user$
            ]]>
          </link>
        </drilldown>

        <option name="count">10</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- ACTIVITY OVER TIME -->
  <row>
    <panel>
      <title>User Activity Over Time</title>
      <chart>
        <search>
          <query>
            | timechart span=1d count by user limit=10
          </query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- RECENT ACTIVITY -->
  <row>
    <panel>
      <title>Recent User Actions</title>
      <table>
        <search>
          <query>
            | eval target=coalesce(resourceId, entityId, workspaceId)
            | table _time user action target result
            | sort _time desc
          </query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

</dashboard>
