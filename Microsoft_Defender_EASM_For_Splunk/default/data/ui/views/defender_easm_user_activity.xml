<!-- defender_easm_user_activity.xml -->
<!-- Microsoft Defender EASM for Splunk App -->
<!-- User Activity & Audit Dashboard with Trends -->

<dashboard version="1.1">
  <label>User Activity & Audit</label>
  <description>
    Auditable user actions across Microsoft Defender EASM with DoD, WoW, MoM, QoQ, and YoY trends.
  </description>

  <!-- Time Picker -->
  <row>
    <panel>
      <input type="time" token="timeRange">
        <label>Time Range</label>
        <default>
          <earliest>-90d@d</earliest>
          <latest>now</latest>
        </default>
      </input>
    </panel>
  </row>

  <!-- DoD / WoW / MoM / QoQ / YoY -->
  <row>
    <panel>
      <title>Activity Trends Over Time</title>
      <chart>
        <search>
          <query>
            index=security_defender_easm
            (
              sourcetype=azure:activitylog
              OR sourcetype=defender:easm:task
              OR sourcetype=defender:easm:report
              OR sourcetype=defender:easm:policy
            )
            | timechart span=1d count AS Day
            | eval Week=strftime(_time,"%Y-%W")
            | eval Month=strftime(_time,"%Y-%m")
            | eval Quarter=strftime(_time,"%Y-Q").((month(_time)-1)/3+1)
            | eval Year=strftime(_time,"%Y")
          </query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
      </chart>
    </panel>
  </row>

  <!-- Top 10 Users -->
  <row>
    <panel>
      <title>Top 10 Users by Activity</title>
      <table>
        <search>
          <query>
            index=security_defender_easm
            (
              sourcetype=azure:activitylog
              OR sourcetype=defender:easm:task
              OR sourcetype=defender:easm:report
            )
            | eval user=coalesce(caller, initiatedBy, createdBy)
            | stats count AS activity_count BY user
            | sort -activity_count
            | head 10
          </query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="count">10</option>
      </table>
    </panel>

    <!-- Top 10 Activity Types -->
    <panel>
      <title>Top 10 Activity Types</title>
      <table>
        <search>
          <query>
            index=security_defender_easm
            (
              sourcetype=azure:activitylog
              OR sourcetype=defender:easm:task
              OR sourcetype=defender:easm:report
            )
            | eval action=coalesce(operationName, taskType, reportType)
            | stats count AS total BY action
            | sort -total
            | head 10
          </query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="count">10</option>
      </table>
    </panel>
  </row>

  <!-- User Ã— Action Matrix -->
  <row>
    <panel>
      <title>User Activity Breakdown</title>
      <table>
        <search>
          <query>
            index=security_defender_easm
            (
              sourcetype=azure:activitylog
              OR sourcetype=defender:easm:task
              OR sourcetype=defender:easm:report
            )
            | eval user=coalesce(caller, initiatedBy, createdBy)
            | eval action=coalesce(operationName, taskType, reportType)
            | stats count BY user action
            | sort -count
            | head 50
          </query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- Compliance Note -->
  <row>
    <panel>
      <html>
        <h3>Audit Coverage Note</h3>
        <p>
          Trends reflect auditable control-plane and operational actions.
          UI-level clickstream data is not available in Microsoft Defender EASM APIs.
        </p>
      </html>
    </panel>
  </row>

</dashboard>
