<!--
  File: defender_easm_discovery_templates.xml
  Purpose: Manage â†’ Discovery Templates
-->

<dashboard version="1.1">
  <label>Discovery Templates</label>

  <description>
    Inventory and lifecycle visibility of Defender EASM discovery templates
    collected from the data-plane Discovery Templates API.
  </description>

  <!-- ========================= -->
  <!-- BASE SEARCH -->
  <!-- ========================= -->
  <search id="base_templates">
    <query>
      `easm_index`
      sourcetype=defender:easm:discovery_template
      | eval
          template_name=name,
          provisioning_state=properties.provisioningState,
          created_time=systemData.createdAt,
          modified_time=systemData.lastModifiedAt,
          created_by=systemData.createdBy,
          modified_by=systemData.lastModifiedBy
    </query>
    <earliest>-90d@d</earliest>
    <latest>now</latest>
  </search>

  <!-- ========================= -->
  <!-- KPI OVERVIEW -->
  <!-- ========================= -->
  <row>
    <panel>
      <single>
        <title>Total Discovery Templates</title>
        <search base="base_templates">
          <query>| stats count</query>
        </search>
      </single>
    </panel>

    <panel>
      <single>
        <title>Provisioned</title>
        <search base="base_templates">
          <query>
            | search provisioning_state="Succeeded"
            | stats count
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <single>
        <title>Updating / Creating</title>
        <search base="base_templates">
          <query>
            | search provisioning_state IN ("Creating","Updating")
            | stats count
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <single>
        <title>Failed</title>
        <search base="base_templates">
          <query>
            | search provisioning_state="Failed"
            | stats count
          </query>
        </search>
      </single>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- PROVISIONING STATE -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Templates by Provisioning State</title>
      <chart>
        <search base="base_templates">
          <query>
            | stats count by provisioning_state
          </query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- TEMPLATE INVENTORY -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Discovery Template Inventory</title>
      <table>
        <search base="base_templates">
          <query>
            | table
                template_name
                provisioning_state
                created_time
                modified_time
                created_by
                modified_by
            | sort template_name
          </query>
        </search>

        <option name="count">20</option>
        <option name="wrap">true</option>

        <drilldown>
          <set token="template_name">$row.template_name$</set>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- CHANGE ACTIVITY -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Recent Template Changes</title>
      <table>
        <search base="base_templates">
          <query>
            | sort - modified_time
            | table
                modified_time
                template_name
                modified_by
                provisioning_state
          </query>
        </search>

        <option name="count">15</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

</dashboard>
