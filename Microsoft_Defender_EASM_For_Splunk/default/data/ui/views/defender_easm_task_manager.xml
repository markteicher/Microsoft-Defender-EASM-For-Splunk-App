<!--
    defender_easm_task_manager.xml
    Microsoft Defender EASM for Splunk App

    Dashboard: Task Manager
    Navigation: Manage â†’ Task Manager
-->

<dashboard version="1.1">
  <label>ðŸ§  Defender EASM â€“ Task Manager</label>
  <description>
    Monitor Microsoft Defender EASM background tasks including discovery,
    inventory updates, enrichment jobs, and control-plane operations.
  </description>

  <!-- ========================= -->
  <!-- ROW 1: TASK SUMMARY KPIs  -->
  <!-- ========================= -->
  <row>

    <panel>
      <title>Total Tasks</title>
      <single>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | stats count
          </query>
        </search>
        <option name="unit">tasks</option>
      </single>
    </panel>

    <panel>
      <title>Task Status</title>
      <chart>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | stats count by status
          </query>
        </search>
        <option name="charting.chart">pie</option>
      </chart>
    </panel>

    <panel>
      <title>Task Type</title>
      <chart>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | stats count by taskType
          </query>
        </search>
        <option name="charting.chart">bar</option>
      </chart>
    </panel>

  </row>

  <!-- ========================= -->
  <!-- ROW 2: EXECUTION TIMING   -->
  <!-- ========================= -->
  <row>

    <panel>
      <title>Average Task Duration</title>
      <chart>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | eval
                start_epoch=strptime(startTime,"%Y-%m-%dT%H:%M:%S"),
                end_epoch=strptime(endTime,"%Y-%m-%dT%H:%M:%S")
            | where isnotnull(end_epoch)
            | eval duration_sec=round(end_epoch-start_epoch,2)
            | stats avg(duration_sec) as avg_duration by taskType
          </query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleX.text">Task Type</option>
        <option name="charting.axisTitleY.text">Avg Duration (seconds)</option>
      </chart>
    </panel>

    <panel>
      <title>Tasks Over Time</title>
      <chart>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | timechart span=1h count
          </query>
        </search>
        <option name="charting.chart">line</option>
      </chart>
    </panel>

  </row>

  <!-- ========================= -->
  <!-- ROW 3: FAILED TASKS       -->
  <!-- ========================= -->
  <row>

    <panel>
      <title>Recent Failed Tasks</title>
      <table>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | where status="Failed" OR status="Error"
            | table
                _time
                taskId
                taskType
                status
                failureReason
                errorCode
                errorMessage
                createdBy
            | sort -_time
          </query>
        </search>

        <drilldown>
          <link>
            <![CDATA[
              /app/microsoft_defender_easm/defender_easm_task_detail?task_id=$row.taskId$
            ]]>
          </link>
        </drilldown>

        <option name="count">10</option>
        <option name="wrap">true</option>
      </table>
    </panel>

  </row>

  <!-- ========================= -->
  <!-- ROW 4: TASK INVENTORY     -->
  <!-- ========================= -->
  <row>

    <panel>
      <title>Task Inventory</title>
      <table>
        <search>
          <query>
            `easm_index`
            sourcetype=defender:easm:task
            | eval
                start_epoch=strptime(startTime,"%Y-%m-%dT%H:%M:%S"),
                end_epoch=strptime(endTime,"%Y-%m-%dT%H:%M:%S")
            | eval
                duration_seconds=if(isnull(end_epoch),null(),round(end_epoch-start_epoch,2))
            | table
                taskId
                taskType
                status
                duration_seconds
                startTime
                endTime
                createdBy
            | sort -startTime
          </query>
        </search>

        <drilldown>
          <link>
            <![CDATA[
              /app/microsoft_defender_easm/defender_easm_task_detail?task_id=$row.taskId$
            ]]>
          </link>
        </drilldown>

        <option name="count">20</option>
        <option name="wrap">true</option>
      </table>
    </panel>

  </row>

</dashboard>
