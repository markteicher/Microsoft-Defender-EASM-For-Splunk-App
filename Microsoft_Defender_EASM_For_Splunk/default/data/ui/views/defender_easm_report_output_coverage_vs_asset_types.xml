<!-- defender_easm_report_output_coverage_vs_asset_types.xml -->
<!-- Microsoft Defender EASM for Splunk App -->
<!-- Dashboard: Report Output Coverage vs Asset Types -->

<dashboard version="1.1">
  <label>Report Coverage vs Asset Types</label>

  <description>
    Visibility into Microsoft Defender EASM report output coverage across
    asset types. Highlights coverage distribution and gaps between inventory
    and reported assets.
  </description>

  <!-- ========================= -->
  <!-- TIME RANGE -->
  <!-- ========================= -->

  <fieldset submitButton="false">
    <input type="time" token="time">
      <label>Time Range</label>
      <default>
        <earliest>-30d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- ========================= -->
  <!-- BASE SEARCH: REPORT OUTPUT -->
  <!-- ========================= -->

  <search id="report_output">
    <query>
      `easm_index`
      sourcetype=defender:easm:report_output
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>

  <!-- ========================= -->
  <!-- COVERAGE SUMMARY -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>Report Coverage by Asset Type</title>
      <table>
        <search base="report_output">
          <query>
            | stats
                dc(report_id) AS reports_generated
                dc(asset_id)  AS assets_reported
              BY asset_type
            | sort - assets_reported
          </query>
        </search>
        <option name="count">10</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- COVERAGE DISTRIBUTION -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>Reported Asset Distribution</title>
      <chart>
        <search base="report_output">
          <query>
            | stats dc(asset_id) AS assets_reported BY asset_type
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- COVERAGE GAP ANALYSIS -->
  <!-- ========================= -->

  <row>
    <panel>
      <title>Coverage Gaps by Asset Type</title>
      <table>
        <search>
          <query>
            `easm_index` `easm_assets_sourcetypes`
            | stats dc(id) AS total_assets BY sourcetype
            | eval asset_type=case(
                sourcetype="defender:easm:domain","Domain",
                sourcetype="defender:easm:host","Host",
                sourcetype="defender:easm:page","Page",
                sourcetype="defender:easm:ip","IP Address",
                sourcetype="defender:easm:ip_block","IP Block",
                sourcetype="defender:easm:asn","ASN",
                sourcetype="defender:easm:ssl_certificate","SSL Certificate",
                sourcetype="defender:easm:whois_contact","WHOIS Contact"
              )
            | fields asset_type total_assets
            | join asset_type [
                search `easm_index` sourcetype=defender:easm:report_output
                | stats dc(asset_id) AS reported_assets BY asset_type
              ]
            | eval reported_assets=coalesce(reported_assets,0)
            | eval coverage_percent=round((reported_assets/total_assets)*100,2)
            | table asset_type total_assets reported_assets coverage_percent
            | sort coverage_percent
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>

        <option name="count">10</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

</dashboard>
