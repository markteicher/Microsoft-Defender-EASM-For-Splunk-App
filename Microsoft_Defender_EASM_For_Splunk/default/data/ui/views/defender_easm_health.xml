<!--
  File: defender_easm_health.xml
  Purpose: Dashboards â†’ Health
-->

<dashboard version="1.1">
  <label>Health</label>

  <description>
    Platform and ingestion health visibility for Microsoft Defender
    External Attack Surface Management. Displays component status,
    failures, and operational trends.
  </description>

  <!-- ========================= -->
  <!-- BASE SEARCH -->
  <!-- ========================= -->
  <search id="base_health">
    <query>
      `easm_index`
      sourcetype=defender:easm:health
      | eval
          component=coalesce(componentName, name, properties.name),
          status=coalesce(status, properties.status),
          error_code=coalesce(errorCode, properties.errorCode),
          error_message=coalesce(errorMessage, properties.errorMessage),
          event_time=coalesce(lastCheckedTime, _time)
    </query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
  </search>

  <!-- ========================= -->
  <!-- HEALTH KPIs -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Overall Health</title>
      <single>
        <search base="base_health">
          <query>
            | stats latest(status) AS status
            | eval display=case(
                status="Healthy","ðŸŸ¢ Healthy",
                status="Degraded","ðŸŸ  Degraded",
                status="Failed","ðŸ”´ Failed",
                true(),"âšª Unknown"
              )
            | fields display
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>Components Reporting</title>
      <single>
        <search base="base_health">
          <query>
            | stats dc(component)
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>Failures (24h)</title>
      <single>
        <search base="base_health">
          <query>
            | search status="Failed"
            | stats count
          </query>
        </search>
      </single>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- COMPONENT STATUS TABLE -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Component Health Status</title>
      <table>
        <search base="base_health">
          <query>
            | eval status_icon=case(
                status="Healthy","ðŸŸ¢",
                status="Degraded","ðŸŸ ",
                status="Failed","ðŸ”´",
                true(),"âšª"
              )
            | table
                status_icon
                component
                status
                event_time
                error_code
                error_message
            | sort component
          </query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- HEALTH TREND -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Health Status Trend</title>
      <chart>
        <search base="base_health">
          <query>
            | eval health_level=case(
                status="Healthy",1,
                status="Degraded",2,
                status="Failed",3,
                true(),0
              )
            | timechart span=1h max(health_level) AS health_level
          </query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.axisY.title">Health Level</option>
        <option name="charting.legend.placement">none</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- RECENT ERRORS -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Recent Health Errors</title>
      <table>
        <search base="base_health">
          <query>
            | search status="Failed"
            | table _time component error_code error_message
            | sort - _time
          </query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

</dashboard>
