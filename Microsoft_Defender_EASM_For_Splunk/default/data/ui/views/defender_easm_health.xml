<!-- defender_easm_health.xml -->
<!-- Microsoft Defender EASM for Splunk App -->
<!-- Platform & Ingestion Health Monitoring -->

<dashboard version="1.1">
  <label>â¤ï¸ Health</label>
  <description>
    Real-time platform health, API availability, and ingestion status
    for Microsoft Defender External Attack Surface Management.
  </description>

  <!-- BASE SEARCH -->
  <search>
    <query>
      index=security_defender_easm
      sourcetype=defender:easm:health
    </query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
  </search>

  <!-- HEALTH KPIs -->
  <row>
    <panel>
      <title>â¤ï¸ Overall Health</title>
      <single>
        <search>
          <query>
            | stats latest(status) AS status
            | eval status_icon=case(
                status="Healthy","ğŸŸ¢ Healthy",
                status="Degraded","ğŸŸ  Degraded",
                status="Failed","ğŸ”´ Failed"
              )
            | fields status_icon
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>ğŸ•’ Last Successful Collection</title>
      <single>
        <search>
          <query>
            | stats latest(lastSuccessTime) AS last_success
            | eval freshness=now()-strptime(last_success,"%Y-%m-%dT%H:%M:%S")
            | eval freshness_readable=case(
                freshness<300,"Just now",
                freshness<3600,round(freshness/60)." minutes ago",
                freshness<86400,round(freshness/3600)." hours ago",
                true(),round(freshness/86400)." days ago"
              )
            | fields freshness_readable
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>âŒ Failed Collections (24h)</title>
      <single>
        <search>
          <query>
            | where status="Failed"
            | stats count
          </query>
        </search>
      </single>
    </panel>
  </row>

  <!-- COMPONENT STATUS -->
  <row>
    <panel>
      <title>ğŸ§© Component Health Status</title>
      <table>
        <search>
          <query>
            | eval status_icon=case(
                status="Healthy","ğŸŸ¢",
                status="Degraded","ğŸŸ ",
                status="Failed","ğŸ”´"
              )
            | table
                status_icon
                componentName
                status
                lastCheckedTime
                errorCode
                errorMessage
          </query>
        </search>
        <option name="count">15</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- HEALTH TREND -->
  <row>
    <panel>
      <title>ğŸ“ˆ Health Status Over Time</title>
      <chart>
        <search>
          <query>
            | eval severity=case(
                status="Healthy",1,
                status="Degraded",2,
                status="Failed",3
              )
            | timechart span=1h max(severity) AS health_level
          </query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisY.title">Health Severity</option>
      </chart>
    </panel>
  </row>

  <!-- RECENT ERRORS -->
  <row>
    <panel>
      <title>ğŸš¨ Recent Health Errors</title>
      <table>
        <search>
          <query>
            | where status="Failed"
            | table _time componentName errorCode errorMessage
            | sort _time desc
          </query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

</dashboard>
