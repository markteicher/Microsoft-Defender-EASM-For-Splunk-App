<!--
  File: defender_easm_inventory_changes.xml
  Location: default/data/ui/views/
  Purpose: General â†’ Inventory Changes
-->

<dashboard version="1.1">
  <label>Inventory Changes</label>

  <description>
    Track additions and removals of Microsoft Defender EASM assets over time
    based on inventory change events.
  </description>

  <!-- ========================= -->
  <!-- BASE SEARCH -->
  <!-- ========================= -->
  <search id="base_inventory_changes">
    <query>
      `easm_index`
      sourcetype=defender:easm:inventory_changes
      | eval
          change_action=coalesce(action, changeType, eventType, operation),
          asset_type=coalesce(asset_type, assetType, properties.assetType)
    </query>
    <earliest>-30d@d</earliest>
    <latest>now</latest>
  </search>

  <!-- ========================= -->
  <!-- KPI ROW -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Total Inventory Changes</title>
      <single>
        <search base="base_inventory_changes">
          <query>
            | stats count
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>Assets Added</title>
      <single>
        <search base="base_inventory_changes">
          <query>
            | search change_action IN ("Added","Add","Create","Created")
            | stats count
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>Assets Removed</title>
      <single>
        <search base="base_inventory_changes">
          <query>
            | search change_action IN ("Removed","Delete","Deleted")
            | stats count
          </query>
        </search>
      </single>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- DISTRIBUTION -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Change Distribution</title>
      <chart>
        <search base="base_inventory_changes">
          <query>
            | stats count by change_action
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>

    <panel>
      <title>Changes by Asset Type</title>
      <chart>
        <search base="base_inventory_changes">
          <query>
            | stats count by asset_type
            | sort - count
          </query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- TIME SERIES -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Inventory Change Trend</title>
      <chart>
        <search base="base_inventory_changes">
          <query>
            | timechart span=1d count by change_action
          </query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- DETAIL TABLE -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Inventory Change Details</title>
      <table>
        <search base="base_inventory_changes">
          <query>
            | eval change_date=strftime(_time,"%Y-%m-%d")
            | table
                change_date
                change_action
                asset_type
            | sort - change_date
          </query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

</dashboard>
