<!-- default/data/ui/views/defender_easm_data_connections.xml -->
<!-- Microsoft Defender EASM for Splunk App -->
<!-- Data Connections â€“ aligned to data-plane API -->

<dashboard version="1.1">
  <label>Data Connections</label>

  <description>
    Operational view of Defender EASM data-plane connections including
    connection type, status, sync cadence, and runtime health.
  </description>

  <!-- Base search -->
  <search id="base_data_connections">
    <query>
      index=security_defender_easm sourcetype=defender:easm:data_connection
      | eval last_run=strftime(lastRunTime,"%Y-%m-%d %H:%M:%S")
      | eval next_run=strftime(nextRunTime,"%Y-%m-%d %H:%M:%S")
      | eval created=strftime(createdTime,"%Y-%m-%d %H:%M:%S")
      | eval updated=strftime(updatedTime,"%Y-%m-%d %H:%M:%S")
    </query>
    <earliest>-24h</earliest>
    <latest>now</latest>
  </search>

  <!-- KPI Row -->
  <row>
    <panel>
      <single>
        <search base="base_data_connections">
          <query>| stats count</query>
        </search>
        <title>Total Data Connections</title>
      </single>
    </panel>

    <panel>
      <single>
        <search base="base_data_connections">
          <query>| search status="Connected" | stats count</query>
        </search>
        <title>Connected</title>
      </single>
    </panel>

    <panel>
      <single>
        <search base="base_data_connections">
          <query>| search status!="Connected" | stats count</query>
        </search>
        <title>Disconnected / Error</title>
      </single>
    </panel>
  </row>

  <!-- Data Connections Table -->
  <row>
    <panel>
      <title>Data Connection Inventory</title>

      <table>
        <search base="base_data_connections">
          <query>
            | table name type status content frequency last_run next_run created updated
            | sort name
          </query>
        </search>

        <option name="count">20</option>
        <option name="wrap">true</option>

        <!-- Drilldown -->
        <drilldown>
          <set token="dc_name">$row.name$</set>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Detail Panel -->
  <row>
    <panel>
      <title>Connection Details: $dc_name$</title>

      <table>
        <search base="base_data_connections">
          <query>
            | search name="$dc_name$"
            | transpose
            | rename column as Field, row 1 as Value
          </query>
        </search>
        <option name="count">20</option>
      </table>
    </panel>
  </row>

</dashboard>
