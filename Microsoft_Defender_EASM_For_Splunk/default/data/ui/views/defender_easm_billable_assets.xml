<!--
File: defender_easm_billable_assets.xml
Location: default/data/ui/views/
Purpose: Manage â†’ Billable Assets
-->

<dashboard version="1.1">
  <label>Billable Assets</label>
  <description>
    Visibility into Microsoft Defender EASM billable asset consumption and breakdown by asset type.
  </description>

  <!-- KPI SUMMARY -->
  <row>
    <panel>
      <title>Total Billable Assets</title>
      <single>
        <search>
          <query>
            index=security_defender_easm
            sourcetype=defender:easm:assets
            billable=true
            | stats count as total_billable
          </query>
          <earliest>-30d</earliest>
          <latest>now</latest>
        </search>
      </single>
    </panel>

    <panel>
      <title>Non-Billable Assets</title>
      <single>
        <search>
          <query>
            index=security_defender_easm
            sourcetype=defender:easm:assets
            billable=false
            | stats count as non_billable
          </query>
          <earliest>-30d</earliest>
          <latest>now</latest>
        </search>
      </single>
    </panel>

    <panel>
      <title>Billable Asset Types</title>
      <single>
        <search>
          <query>
            index=security_defender_easm
            sourcetype=defender:easm:assets
            billable=true
            | stats dc(asset_type) as asset_types
          </query>
          <earliest>-30d</earliest>
          <latest>now</latest>
        </search>
      </single>
    </panel>
  </row>

  <!-- DISTRIBUTION -->
  <row>
    <panel>
      <title>Billable Assets by Type</title>
      <chart>
        <search>
          <query>
            index=security_defender_easm
            sourcetype=defender:easm:assets
            billable=true
            | stats count by asset_type
          </query>
          <earliest>-30d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
      </chart>
    </panel>

    <panel>
      <title>Billable vs Non-Billable</title>
      <chart>
        <search>
          <query>
            index=security_defender_easm
            sourcetype=defender:easm:assets
            | stats count by billable
          </query>
          <earliest>-30d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- TREND -->
  <row>
    <panel>
      <title>Billable Asset Trend</title>
      <chart>
        <search>
          <query>
            index=security_defender_easm
            sourcetype=defender:easm:assets
            billable=true
            | timechart span=1d count
          </query>
          <earliest>-30d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">none</option>
      </chart>
    </panel>
  </row>

  <!-- DETAIL TABLE -->
  <row>
    <panel>
      <title>Billable Asset Details</title>
      <table>
        <search>
          <query>
            index=security_defender_easm
            sourcetype=defender:easm:assets
            billable=true
            | eval first_seen=strftime(first_seen,"%Y-%m-%d")
            | eval last_seen=strftime(last_seen,"%Y-%m-%d")
            | table asset_id asset_type asset_name first_seen last_seen
            | sort asset_type asset_name
          </query>
          <earliest>-30d</earliest>
          <latest>now</latest>
        </search>
        <option name="count">25</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

</dashboard>
